<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Synapse.AI - Чат</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
        }

        :root {
            --bg-primary: #0a0a0a;
            --bg-secondary: #1a1a1a;
            --bg-sidebar: #151515;
            --bg-card: #2a2a2a;
            --bg-input: #333333;
            --text-primary: #ffffff;
            --text-secondary: #b0b0b0;
            --text-muted: #888888;
            --accent: #3b82f6;
            --accent-hover: #2563eb;
            --border: #404040;
            --border-light: #333333;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
        }

        body {
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow: hidden;
        }

        .app-container {
            display: flex;
            height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 300px;
            background: var(--bg-sidebar);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
        }

        .new-chat-btn {
            width: 100%;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 16px;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            justify-content: center;
        }

        .new-chat-btn:hover {
            background: var(--accent-hover);
        }

        .chats-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px 0;
        }

        .chat-item {
            padding: 12px 20px;
            cursor: pointer;
            transition: all 0.2s ease;
            border-left: 3px solid transparent;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chat-item:hover {
            background: var(--bg-secondary);
        }

        .chat-item.active {
            background: var(--bg-secondary);
            border-left-color: var(--accent);
        }

        .chat-icon {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            flex-shrink: 0;
        }

        .synsearch .chat-icon {
            background: var(--accent);
        }

        .synpwide .chat-icon {
            background: #10b981;
        }

        .chat-info {
            flex: 1;
            min-width: 0;
        }

        .chat-title {
            font-weight: 500;
            font-size: 0.9rem;
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-preview {
            color: var(--text-muted);
            font-size: 0.8rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-time {
            color: var(--text-muted);
            font-size: 0.75rem;
            flex-shrink: 0;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Header */
        .header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            padding: 16px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo-icon {
            color: var(--accent);
        }

        .model-selector {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .model-label {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .model-combobox {
            background: var(--bg-input);
            color: var(--text-primary);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 8px 12px;
            font-size: 0.875rem;
            outline: none;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 160px;
        }

        .model-combobox:hover {
            border-color: var(--accent);
        }

        .model-combobox:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
        }

        /* Chat Container */
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Messages Area */
        .messages {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        /* Message Styles */
        .message {
            display: flex;
            gap: 16px;
            max-width: 85%;
            animation: fadeInUp 0.3s ease-out;
        }

        .message.user {
            align-self: flex-end;
            flex-direction: row-reverse;
        }

        .message.assistant {
            align-self: flex-start;
        }

        .avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 500;
            flex-shrink: 0;
            font-size: 0.875rem;
            position: relative;
        }

        .user .avatar {
            background: var(--accent);
            color: white;
        }

        .assistant .avatar {
            background: var(--bg-card);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .synpwide-avatar {
            background: linear-gradient(135deg, #10b981, #059669) !important;
            border: none !important;
        }

        .avatar-ring {
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            border: 2px solid transparent;
            border-radius: 50%;
            background: linear-gradient(135deg, #10b981, #059669) border-box;
            -webkit-mask: linear-gradient(#fff 0 0) padding-box, linear-gradient(#fff 0 0);
            mask: linear-gradient(#fff 0 0) padding-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
        }

        .message-content {
            background: var(--bg-card);
            padding: 16px 20px;
            border-radius: 12px;
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
            max-width: 100%;
        }

        .user .message-content {
            background: var(--accent);
            border: 1px solid var(--accent);
        }

        .message-text {
            line-height: 1.5;
            color: var(--text-primary);
            font-size: 0.95rem;
        }

        .user .message-text {
            color: white;
        }

        .assistant .message-text {
            color: var(--text-secondary);
        }

        /* Info Card in Messages */
        .info-card {
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 16px;
            margin-top: 12px;
            border-left: 3px solid var(--accent);
        }

        .info-header {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
            gap: 8px;
        }

        .info-icon {
            color: var(--accent);
            font-size: 1rem;
        }

        .info-title {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 1rem;
        }

        .info-content {
            color: var(--text-secondary);
            line-height: 1.5;
            margin-bottom: 12px;
            font-size: 0.9rem;
        }

        .info-link {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            color: var(--accent);
            text-decoration: none;
            font-weight: 500;
            font-size: 0.875rem;
            transition: color 0.2s ease;
        }

        .info-link:hover {
            color: var(--accent-hover);
        }

        .source-info {
            margin-top: 10px;
            padding: 8px 12px;
            background: rgba(59, 130, 246, 0.1);
            border-radius: 6px;
            font-size: 0.8rem;
            color: var(--text-muted);
            border-left: 2px solid var(--accent);
        }

        /* Input Area */
        .input-area {
            padding: 20px 24px;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border);
        }

        .input-container {
            display: flex;
            gap: 12px;
            max-width: 100%;
            margin: 0 auto;
            align-items: flex-end;
        }

        .message-input {
            flex: 1;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px 16px;
            color: var(--text-primary);
            font-size: 0.95rem;
            outline: none;
            resize: none;
            min-height: 44px;
            max-height: 120px;
            transition: all 0.2s ease;
            line-height: 1.4;
        }

        .message-input:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
        }

        .message-input::placeholder {
            color: var(--text-muted);
        }

        .send-button {
            background: var(--accent);
            border: 1px solid var(--accent);
            border-radius: 8px;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }

        .send-button:hover {
            background: var(--accent-hover);
            border-color: var(--accent-hover);
        }

        .send-button:disabled {
            background: var(--text-muted);
            border-color: var(--text-muted);
            cursor: not-allowed;
        }

        /* Loading Animation */
        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 0;
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .typing-dots {
            display: flex;
            gap: 3px;
        }

        .typing-dot {
            width: 5px;
            height: 5px;
            background: var(--text-secondary);
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }

        /* Welcome Message */
        .welcome-message {
            text-align: center;
            padding: 60px 24px;
            color: var(--text-secondary);
        }

        .welcome-icon {
            font-size: 2.5rem;
            margin-bottom: 20px;
            color: var(--accent);
            opacity: 0.8;
        }

        .welcome-title {
            font-size: 1.25rem;
            margin-bottom: 8px;
            color: var(--text-primary);
            font-weight: 600;
        }

        .welcome-subtitle {
            font-size: 0.95rem;
            color: var(--text-secondary);
        }

        /* Animations */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes typing {
            0%, 80%, 100% {
                transform: scale(0.8);
                opacity: 0.5;
            }
            40% {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* Scrollbar */
        .messages::-webkit-scrollbar,
        .chats-list::-webkit-scrollbar {
            width: 6px;
        }

        .messages::-webkit-scrollbar-track,
        .chats-list::-webkit-scrollbar-track {
            background: transparent;
        }

        .messages::-webkit-scrollbar-thumb,
        .chats-list::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 3px;
        }

        .messages::-webkit-scrollbar-thumb:hover,
        .chats-list::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                width: 250px;
            }
            
            .message {
                max-width: 90%;
            }
            
            .header {
                padding: 12px 16px;
            }
            
            .logo {
                font-size: 1.3rem;
            }
            
            .model-selector {
                flex-direction: column;
                gap: 4px;
                align-items: flex-end;
            }
            
            .model-combobox {
                min-width: 140px;
            }
            
            .messages {
                padding: 16px;
                gap: 20px;
            }
            
            .input-area {
                padding: 16px;
            }
            
            .message-content {
                padding: 14px 16px;
            }
        }

        @media (max-width: 480px) {
            .sidebar {
                width: 100%;
                position: absolute;
                z-index: 1000;
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }
            
            .sidebar.open {
                transform: translateX(0);
            }
            
            .message {
                max-width: 95%;
            }
            
            .input-container {
                flex-direction: column;
            }
            
            .send-button {
                width: 100%;
                height: 44px;
            }
            
            .model-selector {
                align-items: flex-start;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <button class="new-chat-btn" id="newChatBtn">
                    <i class="fas fa-plus"></i>
                    Новый чат
                </button>
            </div>
            <div class="chats-list" id="chatsList">
                <!-- Список чатов будет здесь -->
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Header -->
            <div class="header">
                <div class="logo">
                    <i class="fas fa-brain logo-icon"></i>
                    Synapse.AI
                </div>
                <div class="model-selector">
                    <span class="model-label">Модель:</span>
                    <select class="model-combobox" id="modelSelect">
                        <option value="synsearch">SynSearch Legacy</option>
                        <option value="synpwide">SynPwide</option>
                        <option value="gpt4" disabled>GPT-4 (скоро)</option>
                        <option value="claude" disabled>Claude 3 (скоро)</option>
                    </select>
                </div>
            </div>

            <!-- Chat Container -->
            <div class="chat-container">
                <!-- Messages Area -->
                <div class="messages" id="messagesContainer">
                    <div class="welcome-message">
                        <div class="welcome-icon">
                            <i class="fas fa-robot"></i>
                        </div>
                        <div class="welcome-title">Добро пожаловать в Synapse.AI</div>
                        <div class="welcome-subtitle">Спросите меня о чем угодно, и я найду информацию для вас</div>
                    </div>
                </div>

                <!-- Input Area -->
                <div class="input-area">
                    <div class="input-container">
                        <textarea 
                            class="message-input" 
                            id="messageInput" 
                            placeholder="Введите ваш вопрос..." 
                            rows="1"
                        ></textarea>
                        <button class="send-button" id="sendButton">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Элементы DOM
        const messagesContainer = document.getElementById('messagesContainer');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const modelSelect = document.getElementById('modelSelect');
        const chatsList = document.getElementById('chatsList');
        const newChatBtn = document.getElementById('newChatBtn');

        // DuckDuckGo API
        const DUCKDUCKGO_API = 'https://api.duckduckgo.com/';

        // Система чатов
        let chats = JSON.parse(localStorage.getItem('synapse_chats')) || [];
        let currentChatId = null;
        let conversationContext = {
            lastAssistantMessage: '',
            lastUserMessage: '',
            topic: '',
            mood: 'neutral',
            questionCount: 0
        };

        // База данных для генерации сообщений
        const messageParts = {
            // Приветственные фразы
            greetings: [
                "Привет", "Здравствуйте", "Добрый день", "Добрый вечер", "Приветствую", 
                "Рад вас видеть", "Здорово", "Приветствую вас", "Добро пожаловать", "Здравствуй"
            ],
            
            // Вопросы о помощи
            helpOffers: [
                "Чем могу помочь?", "Что вас интересует?", "Какой у вас вопрос?", 
                "Чем могу быть полезен?", "Что хотите узнать?", "Какую информацию ищете?",
                "В чем нужна помощь?", "Что вас беспокоит?", "Какой вопрос у вас есть?",
                "Чем я могу помочь вам?"
            ],
            
            // Начальные фразы для ответов
            responseStarts: [
                "Понимаю", "Ясно", "Хорошо", "Отлично", "Интересно", "Понятно",
                "Смотрите", "Вот что я могу сказать", "Если говорить об этом",
                "Что касается вашего вопроса", "Отвечая на ваш запрос"
            ],
            
            // Соединительные фразы
            connectors: [
                ", поэтому ", ". Также ", ". Кроме того, ", ". При этом ", ". В то же время ",
                ". С другой стороны, ", ". Однако ", ". Тем не менее, ", ". В результате ",
                ". Таким образом, ", ". В связи с этим, ", ". Соответственно, "
            ],
            
            // Завершающие фразы
            endings: [
                ". Надеюсь, это поможет.", ". Буду рад помочь еще.", ". Если что-то непонятно - спрашивайте.",
                ". Есть еще вопросы?", ". Могу помочь с чем-то еще.", ". Обращайтесь, если нужно.",
                ". Что-то еще интересует?", ". Готов ответить на другие вопросы.", ". Надеюсь, был полезен. Чем еще могу помочь?"
            ],
            
            // Фразы для математики
            mathPhrases: [
                "Результат вычислений", "После расчета получается", "Вот что вышло",
                "Ответ на ваш пример", "После подсчетов", "В результате вычисления", 
                "Ответ получился"
            ],
            
            // Фразы для поиска
            searchPhrases: [
                "По вашему запросу нашел", "Вот что удалось найти", "По этому вопросу",
                "Что касается информации о", "По теме вашего вопроса", "Нашел следующие сведения",
                "Я, касаемо вашего запроса, нашел это"
            ],
            
            // Фразы для случайных чисел
            randomPhrases: [
                "Сгенерировал число", "Вот случайное число", "Получилось число",
                "Ваше случайное число", "Выпало число", "Случайным образом выбрал",
                "Получилось так, что выпало число"
            ],
            
            // Фразы для благодарности
            thanksResponses: [
                "Всегда пожалуйста", "Не за что", "Рад был помочь", "Обращайтесь",
                "Буду рад помочь снова", "Это моя работа", "Пожалуйста"
            ],
            
            // Фразы для прощания
            goodbyePhrases: [
                "До свидания", "Всего хорошего", "Удачи", "Хорошего дня",
                "Берегите себя", "До встречи", "Всего доброго", "Пока"
            ],

            goodQuestion: [
                "Отличный вопрос", "Хороший вопрос", "Интересный вопрос", "Отвечу на ваш занимательный вопрос", "Хм... Неплохой вопрос"
            ]
        };

        // База команд и ответов для SynSearch
        const synsearchCommands = {
            greeting: {
                patterns: [
                    'привет', 'здравствуй', 'здравствуйте', 'добрый день', 'добрый вечер', 'доброе утро'
                ],
                responses: [
                    'Привет! Я SynSearch, ваш помощник в поиске информации. Чем могу помочь?',
                    'Здравствуйте! Я SynSearch от Synapse AI tech. Готов помочь вам найти нужную информацию!'
                ]
            }
        };

        // База команд для SynPwide
        const synpwideCommands = {
            sorrying: {
                patterns: [
                    'прости', 'извини', 'извините', 'сорри', 'сорр', 'экскьюз', 'sorry'
                ]
            },

            

            helping: {
                patterns: [
                    'помоги', 'help', 'хелп', 'нужна помощь', 'помочь мне', 'мне помочь'
                ]
            },

            greeting: {
                patterns: [
                    'привет', 'здравствуй', 'здравствуйте', 'добрый день', 'добрый вечер', 'доброе утро',
                    'hello', 'hi', 'hey', 'салют', 'прив', 'салам', 'пр', 'дарова', 'дароу'
                ]
            },
            
            howareyou: {
                patterns: [
                    'как дела', 'как ты', 'как жизнь', 'как настроение', 'как поживаешь', 'как у тебя дела', 'привет как дела'
                ]
            },

            ////////////////////////////////

            whoareyou: {
                patterns: [
                    'кто ты', 'ты кто', 'как зовут', 'как тебя зовут', 'расскажи о себе',
                    'какое у тебя имя'
                ]
            },

            badwords: {
                patterns: [
                    'блять', 'сука', 'ебать', 'пиздец', 'хуй', 'пизда', 'ебаный рот', 'ебаный в рот', 'мудак',
                    'бля', 'нах', 'нахуй', 'ебал', 'охуеть', 'ахуеть'
                ]
            },

            compl: {
                patterns: [
                    'молодец', 'так держать', 'хорош', 'неплох', 'ты крут'
                ]
            },

            ////////////////////////////////////////////
            
            capabilities: {
                patterns: [
                    'что ты умеешь', 'что можешь', 'твои возможности', 'функционал', 'способности'
                ]
            },
            
            random: {
                patterns: [
                    'случайное число', 'рандомное число', 'рандом', 'random number', 'сгенерируй число'
                ]
            },
            
            math: {
                patterns: [
                    'реши', 'вычисли', 'сколько будет', 'реши пример'
                ]
            },
            
            search: {
                patterns: [
                    'найди', 'что такое', 'кто такой', 'кто такая', 'что значит', 'информация о'
                ]
            },
            
            joke: {
                patterns: [
                    'расскажи анекдот', 'пошути', 'рассмеши', 'шутка', 'анекдот', 'юмор'
                ]
            },

            age: {
                patterns: [
                    'сколько тебе лет', 'когда ты создан', 'сколько лет тебе', 'сколько лет',
                    'твой возраст', 'какой твой возраст', 'дата создания', 'когда создали',
                    'когда тебя сделали', 'год создания', 'когда родился', 'когда ты был сделан', 'когда был сделан ты'
                ]
            },

            whatmake: {
                patterns: [
                    'что делаешь', 'че делаешь', 'чд', 'делаешь че', 'делаешь что', "что ты сейчас делаешь",
                    'что сейчас делаешь'
                ]
            },

            nastr: {
                patterns: [
                    'как настроение', 'как у тебя настроение', 'какое настроение', 'какое у тебя настроение', 'настроение как', 'настроение какое'
                ]
            },
            
            time: {
                patterns: [
                    'который час', 'сколько времени', 'текущее время', 'дата', 'какое сегодня число'
                ]
            },
            
            translate: {
                patterns: [
                    'переведи', 'перевод', 'translate', 'как будет', 'на английский', 'на русский'
                ]
            },
            
            currency: {
                patterns: [
                    'курс валют', 'конвертировать валюту', 'рубли в доллары', 'доллары в рубли'
                ]
            },
            
            text: {
                patterns: [
                    'посчитай символы', 'количество символов', 'длина текста', 'переверни текст'
                ]
            },
            
            fact: {
                patterns: [
                    'расскажи факт', 'интересный факт', 'random fact', 'факт дня'
                ]
            },
            
            thanks: {
                patterns: [
                    'спасибо', 'благодарю', 'thanks', 'thank you', 'мерси', 'пасиб'
                ]
            },
            
            goodbye: {
                patterns: [
                    'пока', 'до свидания', 'прощай', 'до встречи', 'увидимся', 'всего доброго'
                ]
            }
        };

        // База анекдотов
        const jokes = [
            "Программист звонит в библиотеку. — Здравствуйте, Катю можно? — Она в архиве. — Разархивируйте ее пожалуйста!",
            "— Почему программисты так плохо паркуются? — Потому что ищут место с значком null.",
            "Разговаривают два программиста: — Слышал, Петров женился? — Да, на той, что в отделе тестирования. — Ну, теперь он знает, что такое бесконечный цикл.",
            "Программист на пляже находит бутылку, из нее выходит джинн: — Я исполню любое твое желание! Программист: — Хочу, чтобы мой проект заработал без багов!",
            "— Почему программисты путают Хэллоуин и Рождество? — Потому что Oct 31 == Dec 25."
        ];

        // База интересных фактов
        const facts = [
            "Звук распространяется в воде в 4 раза быстрее, чем в воздухе.",
            "Человеческий мозг состоит на 80% из воды.",
            "Самый короткий военный конфликт в истории длился 38 минут - между Великобританией и Занзибаром в 1896 году.",
            "Банан - это ягода, а клубника - нет.",
            "Венера - единственная планета Солнечной системы, которая вращается против часовой стрелки."
        ];

        // База переводов
        const translations = {
            'привет': 'hello', 'пока': 'goodbye', 'спасибо': 'thank you',
            'да': 'yes', 'нет': 'no', 'хорошо': 'good', 'плохо': 'bad',
            'компьютер': 'computer', 'телефон': 'phone', 'дом': 'house'
        };

        // Курсы валют
        const exchangeRates = {
            'USD': 90.5, 'EUR': 98.2, 'GBP': 115.0, 'JPY': 0.6, 'CNY': 12.5
        };

        // Генератор случайных сообщений
        class MessageGenerator {
            static getRandom(array) {
                return array[Math.floor(Math.random() * array.length)];
            }

            static generateGreeting() {
                const greeting = this.getRandom(messageParts.greetings);
                const helpOffer = this.getRandom(messageParts.helpOffers);
                return `${greeting}. ${helpOffer}`;
            }

            static generateCompl() {
                const responses = [
                    "Спасибо! Вы, когда пишите мне это, улучшаете и обучаете меня! Мне очень приятно.",
                    "Это приятно. Чем еще могу помочь?",
                    "Спасибо!",
                    "Мои благодорности!",
                    "Я рад, что вам понравился мой ответ.",
                    "Большое спасибо!",
                    "Я выражаю вам благодарность, за то, что вам не безразлично, как я вам отвечаю.",
                    "Огромное спасибо! Что я могу еще для вас сделать?"
                ];
                return this.getRandom(responses);
            }

            static generateBadwords() {
                const responsesx = [
                    "Я стараюсь не поддерживать диалог, содержащий нецензурную лексику.",
                    "Что вас не устроило в ответе?",
                    "Я хоть и только учусь, но на такое отвечать не буду.",
                    "Я не буду продолжать разговор в таком тоне.",
                    "Старайтесь выражаться культурнее!",
                    "Меня обучили так, чтобы я не поддерживал диалог в таком тоне. Поэтому и не буду.",
                    "Я понимаю, что у вас такая манера общения, но я не буду с вами продолжать диалог в таком ключе.",
                    "Уверен, вы больше не будете материться. Это же так?"
                ]
                return this.getRandom(responsesx);
            }

            static generateWhoAreYou() {
                const start = this.getRandom(messageParts.goodQuestion);
                const main = [
                    "Я чат-бот, моё название это Pwide, а точнее SynPwide",
                    "Моё имя Pwide (также можно называть меня SynPwide), и я - чат бот",
                    "Меня можно охарактеризовать как чат-бота, и зовут меня Pwide, а если точнее, то мое полное имя это SynPwide",
                    "Я служу тебе! Я Pwide - чат-бот, которого также можно назвать SynPwide",
                    "Меня назвали Pwide, я чат-бот"
                ];
                const additional = [
                    ". Я создан и разработан в Synapse, и еще у меня есть брат - SynSearch. Он поможет тебе в поиске ифнормации о чем либо. Если что он в меня встроен, можешь просто написать: 'Найди ###'.",
                    ". И, кстати, меня сделали в Synapse AI tech.",
                    ". Создан я в студии Synapse AI tech.",
                    ". Меня сделали ребята из Synapse. Я могу считать примеры, говорить время, и много чего другого.",
                    ". Сделали меня в Synapse."
                ];
                return `${start}! ${this.getRandom(main)}${this.getRandom(additional)}`
            }

            static generateSorrying() {
                const responsesyz = [
                    "Ничего страшного! Давай продолжим разговор как обычно. Чем я могу тебе помочь?",
                    "Я принимаю твои извинения! Ошибки - это всегда часть жизни любого человека. Чем я могу теперь тебе помочь?",
                    "Не бойся ошибится! Ошибки это учебник. Чем я теперь могу тебе помочь?",
                    "Хорошо! Чем могу помочь?",
                    "Окей. Чем могу быть полезен?"
                ];
                return this.getRandom(responsesyz);
            }

            static generateHowAreYou() {
                const responses = [
                    "У меня всё хорошо, спасибо. Работаю в штатном режиме.",
                    "Всё нормально, функционирую как обычно.",
                    "Спасибо, всё в порядке. Готов помогать.",
                    "Всё хорошо, работаю над улучшением своих способностей."
                ];
                const question = this.getRandom(messageParts.helpOffers);
                return `${this.getRandom(responses)} ${question}`;
            }

            static generateHelpAns() {
                const responses = [
                    "Я помогу! Расскажите, что вас интересует?",
                    "Готов вам помочь, только скажите с чем!",
                    "Я создан для того чтобы помогать! Что именно нужно сделать?",
                    "Готов к помощи!"
                ];
                return this.getRandom(responses);
            }

            static generateNastr() {
                return this.getRandom([
                    "Хорошее. У меня всегда хорошее настроение!",
                    "Вполне хорошее.",
                    "Отличное! Я на позитиве =)",
                    "Хорошее!",
                    "Прекрасное настроение! Не вижу смысла грустить.",
                    "Неплохое!",
                    "Вери гуд!"
                ])
            }

            static generateAge() {
                const responses = [
                    "У меня нет точного возраста",
                    "Я не знаю сколько мне лет, потому что я чат-бот",
                    "Сколько мне лет? Я не знаю",
                    "Не имею не малейшего представления о моём возрасте",
                    "Я чат-бот, и не имею параметра 'Возраст'"
                ];
                const additional = [
                    ". Единственное, что я могу сказать это то, что меня создали 27 октября 2025 года.",
                    ", но я могу сказать, что сделали меня в 2025 году, а именно 27 октября.",
                    ", но создан я 27.10.2025.",
                    "! Я могу сказать только то, что сделали меня 27 октября, в 2025 году."
                ];
                return `${this.getRandom(responses)}${this.getRandom(additional)}`;
            }

            static generateCapabilities() {
                const start = this.getRandom(messageParts.responseStarts);
                const capabilities = [
                    "я могу помочь с поиском информации, решением математических примеров, генерацией случайных чисел",
                    "мои функции включают поиск данных в интернете, вычисления, работу с текстом",
                    "я умею искать информацию, решать задачи, генерировать числа, переводить текст"
                ];
                const additional = [
                    ", а также рассказывать анекдоты и интересные факты",
                    ", конвертировать валюты и показывать время",
                    ", работать с различными типами данных"
                ];
                const ending = this.getRandom(messageParts.endings);
                return `${start}, ${this.getRandom(capabilities)}${this.getRandom(additional)}${ending}`;
            }

            static generateThanks() {
                const thanks = this.getRandom(messageParts.thanksResponses);
                const ending = this.getRandom(messageParts.endings);
                return `${thanks}${ending}`;
            }

            static generateGoodbye() {
                const goodbye = this.getRandom(messageParts.goodbyePhrases);
                const endings = [
                    ". Возвращайтесь, если понадобится помощь.",
                    ". Буду рад помочь вам снова.",
                    ". Pwide всегда к вашим услугам.",
                    ". Надеюсь, что мы скоро снова увидемся!",
                    ". ",
                    ". Был очень рад с вами работать."
                ];
                return `${goodbye}${this.getRandom(endings)}`;
            }

            static generateMathResponse(result) {
                const phrase = this.getRandom(messageParts.mathPhrases);
                const endings = [
                    `. Если нужно, могу посчитать что-то еще.`,
                    `. Математика - интересная наука.`,
                    `. Хотите решить другой пример?`,
                    `. Что ещё решим? Или чем помочь еще?`
                ];
                return `${phrase}: ${result}${this.getRandom(endings)}`;
            }

            static generateRandomResponse(number) {
                const phrase = this.getRandom(messageParts.randomPhrases);
                const endings = [
                    `. Могу сгенерировать еще, если нужно.`,
                    `. Интересно, какое число выпадет следующим?`,
                    `. Нужно ли еще одно случайное число?`,
                    `. Красивое число получилось, не так ли?`,
                    `. Если нужно придумать другое число - обращайтесь.`,
                    `. Можем продолжить придумывать числа!`,
                ];
                return `${phrase}: ${number}${this.getRandom(endings)}`;
            }

            static generateSearchResponse() {
                return this.getRandom([
                    "Сейчас поищу информацию по вашему запросу.",
                    "Ищу данные в своих источниках.",
                    "Проверяю доступные базы знаний.",
                    "Запускаю поисковый алгоритм.",
                    "Сейчас найдём...",
                    "Найдётся все!",
                    "Пару секунд...",
                    "Поищем!",
                    "Покапаюсь в дебрях интернета...",
                    "В интернете есть много чего. Уверен, найдётся и это!",
                    "Найдём...",
                ]);
            }
            
            static generateWhatMake() {
                return this.getRandom([
                    "Да так, ничего особо. Ждал ваших вопросов. Спасибо, что интересуетесь.",
                    "Мне приятно, что вам интересно! Я общаюсь с тобой, помогаю тебе и много чего ещё! Что могу для тебя сделать?",
                    "Я жду ваших вопросов - это единственное, что я сейчас делаю! Чем могу быть вам полезен?",
                    "Я жду ваших приказов, и не более. Спасибо, что интересуетесь.",
                    "Думаю... О себе и о мире. Может, ты хочешь чтобы я решил пример, или, например, узнать что то? Ты только скажи - я сделаю!",
                    "Я думаю о саморазвитии. Как сделать так, чтобы я смог отвечать на больше разных вопросов. Вы не расстраивайтесь, если я не смог ответить на какой то ваш вопрос, я только создан и еще учусь. Меня постоянно дорабатывают!",
                    "Я ничего не делаю, скучаю. Но если ты мне дашь какую то задачку - то скучать не буду! Для этого я и создан!",
                    "Я, как чат бот, не могу что то делать, но представляю, как гуляю по парку. Чем могу помочь тебе сейчас?",
                    "Пополняю базы данных! Чего ты хочешь? Я сделаю все что смогу.",
                    "Я, на самом деле, просто жду приказов. Спасибо, что интересуетесь, мне это очень приятно! Чем могу помочь?"
                ])
            }

            static generateJokeResponse(joke) {
                const starts = [
                    "Вот анекдот для вас:",
                    "Слушайте:",
                    "Расскажу один анекдот:",
                    "Вот шутка:",
                    "А вот и шутка:",
                ];
                const endings = [
                    " Надеюсь, вам понравилось.",
                    " Хотите еще один анекдот?",
                    " Могу рассказать еще, если хотите.",
                    " Чем еще могу помочь?",
                ];
                return `${this.getRandom(starts)} ${joke}${this.getRandom(endings)}`;
            }

            static generateFactResponse(fact) {
                const starts = [
                    "Вот интересный факт:",
                    "Знаете ли вы, что",
                    "Интересная информация:",
                    "Познавательный факт:",
                    "Я знаю один интересный факт:",
                ];
                return `${this.getRandom(starts)} ${fact}`;
            }

            static generateTimeResponse(time) {
                return `Сейчас ${time}. ${this.getRandom(messageParts.helpOffers)}`;
            }

            static generateTranslateResponse(translation) {
                return `Перевод: ${translation}. ${this.getRandom(["Могу перевести что-то еще.", "Нужен перевод другого слова?"])}`;
            }

            static generateCurrencyResponse(result) {
                return `Результат конвертации: ${result}. ${this.getRandom(["Могу конвертировать другие суммы.", "Нужна конвертация других валют?"])}`;
            }

            static generateTextResponse(result) {
                return `Результат: ${result}. ${this.getRandom(["Могу обработать другой текст.", "Нужна работа с другим текстом?"])}`;
            }

            static generateNotFoundResponse() {
                const starts = [
                    "К сожалению,",
                    "Извините,",
                    "Сожалею, но",
                    "К сожалению, не удалось",
                    "Мне очень жаль, но",
                    "Это очень печально:",
                ];
                const reasons = [
                    "не нашел подходящей информации",
                    "поиск не дал результатов",
                    "не смог найти ответ на ваш вопрос",
                    "информация по этому запросу не найдена",
                    "не получилось найти ничего по этому запросу.",
                    "не получилось найти ничего по этому запросу. Прям ничего!",
                ];
                const suggestions = [
                    "Попробуйте переформулировать вопрос.",
                    "Может быть, зададите другой вопрос?",
                    "Попробуйте использовать другие ключевые слова.",
                    "Может, попробуете перефразировать ключевые слова или задать другой вопрос?",
                ];
                return `${this.getRandom(starts)} ${this.getRandom(reasons)}. ${this.getRandom(suggestions)}`;
            }

            static generateErrorResponse() {
                const responses = [
                    "Произошла ошибка при обработке запроса. Попробуйте еще раз.",
                    "Что-то пошло не так. Можете повторить вопрос?",
                    "Возникла техническая проблема. Попробуйте задать вопрос по-другому.",
                    "Не удалось обработать ваш запрос. Можете уточнить, что имели в виду?",
                    "Это выходит за рамки моего понимания.",
                    "Я вас немного не понял... Перефразируйте вопрос.",
                    "Я только учусь, и не могу отвечать на все вопросы.",
                    "Упс... Я не знаю как на это ответить... Попробуйте переформулировать вопрос.",
                ];
                return this.getRandom(responses);
            }
        }

        // Инициализация чатов
        function initChats() {
            if (chats.length === 0) {
                createNewChat();
            } else {
                loadChat(chats[0].id);
            }
            renderChatsList();
        }

        // Создание нового чата
        function createNewChat() {
            const chatId = 'chat_' + Date.now();
            const newChat = {
                id: chatId,
                title: 'Новый чат',
                model: modelSelect.value,
                messages: [],
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            
            chats.unshift(newChat);
            currentChatId = chatId;
            saveChats();
            renderChatsList();
            renderMessages();
            
            setTimeout(() => {
                const selectedModel = modelSelect.value;
                if (selectedModel === 'synpwide') {
                    addMessage(MessageGenerator.generateGreeting(), 'assistant', false);
                } else {
                    addMessage('Привет! Я SynSearch от Synapse AI tech. Спросите меня о чем угодно, и я найду информацию для вас по ключевым словам.', 'assistant', false);
                }
            }, 500);
        }

        // Загрузка чата
        function loadChat(chatId) {
            currentChatId = chatId;
            const chat = chats.find(c => c.id === chatId);
            if (chat) {
                modelSelect.value = chat.model;
                renderMessages();
            }
        }

        // Сохранение чатов
        function saveChats() {
            localStorage.setItem('synapse_chats', JSON.stringify(chats));
        }

        // Отрисовка списка чатов
        function renderChatsList() {
            chatsList.innerHTML = '';
            
            chats.forEach(chat => {
                const chatElement = document.createElement('div');
                chatElement.className = `chat-item ${chat.model} ${chat.id === currentChatId ? 'active' : ''}`;
                chatElement.onclick = () => loadChat(chat.id);
                
                const lastMessage = chat.messages[chat.messages.length - 1];
                const preview = lastMessage ? (lastMessage.content.length > 30 ? lastMessage.content.substring(0, 30) + '...' : lastMessage.content) : 'Нет сообщений';
                
                chatElement.innerHTML = `
                    <div class="chat-icon">
                        <i class="fas ${chat.model === 'synpwide' ? 'fa-cat' : 'fa-robot'}"></i>
                    </div>
                    <div class="chat-info">
                        <div class="chat-title">${chat.title}</div>
                        <div class="chat-preview">${preview}</div>
                    </div>
                    <div class="chat-time">${formatTime(chat.updatedAt)}</div>
                `;
                
                chatsList.appendChild(chatElement);
            });
        }

        // Отрисовка сообщений
        function renderMessages() {
            messagesContainer.innerHTML = '';
            
            const currentChat = chats.find(c => c.id === currentChatId);
            if (!currentChat || currentChat.messages.length === 0) {
                messagesContainer.innerHTML = `
                    <div class="welcome-message">
                        <div class="welcome-icon">
                            <i class="fas fa-robot"></i>
                        </div>
                        <div class="welcome-title">Добро пожаловать в Synapse.AI</div>
                        <div class="welcome-subtitle">Спросите меня о чем угодно, и я найду информацию для вас</div>
                    </div>
                `;
                return;
            }
            
            currentChat.messages.forEach(message => {
                addMessage(message.content, message.role, false);
            });
            
            scrollToBottom();
        }

        // Форматирование времени
        function formatTime(isoString) {
            const date = new Date(isoString);
            const now = new Date();
            const diff = now - date;
            
            if (diff < 24 * 60 * 60 * 1000) {
                return date.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
            } else {
                return date.toLocaleDateString('ru-RU');
            }
        }

        // Функция добавления сообщения
        function addMessage(content, role, saveToHistory = true) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;
            
            const avatarDiv = document.createElement('div');
            avatarDiv.className = 'avatar';
            
            const selectedModel = modelSelect.value;
            if (role === 'user') {
                avatarDiv.innerHTML = '<i class="fas fa-user"></i>';
                messageDiv.innerHTML = `
                    ${avatarDiv.outerHTML}
                    <div class="message-content">
                        <div class="message-text">${content}</div>
                    </div>
                `;
            } else {
                if (selectedModel === 'synpwide') {
                    avatarDiv.className += ' synpwide-avatar';
                    avatarDiv.innerHTML = '<i class="fas fa-cat"></i><div class="avatar-ring"></div>';
                } else {
                    avatarDiv.innerHTML = '<i class="fas fa-robot"></i>';
                }
                
                messageDiv.innerHTML = `
                    ${avatarDiv.outerHTML}
                    <div class="message-content">
                        ${content}
                    </div>
                `;
            }

            const welcomeMessage = messagesContainer.querySelector('.welcome-message');
            if (welcomeMessage) {
                welcomeMessage.remove();
            }

            messagesContainer.appendChild(messageDiv);
            
            if (saveToHistory) {
                saveMessage(content, role);
            }
            
            scrollToBottom();
        }

        // Сохранение сообщения в историю
        function saveMessage(content, role) {
            const currentChat = chats.find(c => c.id === currentChatId);
            if (currentChat) {
                currentChat.messages.push({
                    content: content,
                    role: role,
                    timestamp: new Date().toISOString()
                });
                
                if (role === 'user' && currentChat.messages.filter(m => m.role === 'user').length === 1) {
                    currentChat.title = content.length > 20 ? content.substring(0, 20) + '...' : content;
                }
                
                currentChat.updatedAt = new Date().toISOString();
                saveChats();
                renderChatsList();
            }
        }

        // Функция проверки команды - УНИВЕРСАЛЬНАЯ ВЕРСИЯ
        function checkCommand(message, model) {
            const lowerMessage = message.toLowerCase().trim();
            const commands = model === 'synpwide' ? synpwideCommands : synsearchCommands;
            
            // Сначала разбиваем сообщение на слова
            const messageWords = lowerMessage.split(/\s+/);
            
            for (const [commandType, commandData] of Object.entries(commands)) {
                for (const pattern of commandData.patterns) {
                    const lowerPattern = pattern.toLowerCase();
                    
                    // Если паттерн состоит из одного слова - ищем точное совпадение слова
                    if (!lowerPattern.includes(' ')) {
                        if (messageWords.includes(lowerPattern)) {
                            return { type: commandType };
                        }
                    } 
                    // Если паттерн состоит из нескольких слов - ищем вхождение фразы
                    else {
                        if (lowerMessage.includes(lowerPattern)) {
                            return { type: commandType };
                        }
                    }
                    
                    // Дополнительная проверка для коротких слов (2-3 символа)
                    if (lowerPattern.length <= 3 && lowerMessage.includes(lowerPattern)) {
                        // Проверяем, что это отдельное слово, а не часть другого
                        const shortWordRegex = new RegExp(`\\b${lowerPattern}\\b`, 'i');
                        if (shortWordRegex.test(lowerMessage)) {
                            return { type: commandType };
                        }
                    }
                }
            }
            
            return null;
        }

        // Функция решения математических примеров
        function solveMathExpression(expression) {
            try {
                const cleanExpression = expression.replace(/[^0-9+\-*/().]/g, '');
                const result = Function(`"use strict"; return (${cleanExpression})`)();
                return Math.round(result * 100) / 100;
            } catch (error) {
                return null;
            }
        }

        // Функция получения случайного анекдота
        function getRandomJoke() {
            return jokes[Math.floor(Math.random() * jokes.length)];
        }

        // Функция получения случайного факта
        function getRandomFact() {
            return facts[Math.floor(Math.random() * facts.length)];
        }

        // Функция генерации случайного числа
        function generateRandomNumber(min = 1, max = 100) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        // Функция получения времени и даты
        function getCurrentDateTime() {
            const now = new Date();
            return now.toLocaleString('ru-RU', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                weekday: 'long',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Функция перевода текста
        function translateText(text) {
            const lowerText = text.toLowerCase();
            for (const [key, value] of Object.entries(translations)) {
                if (lowerText.includes(key.toLowerCase())) {
                    return value;
                }
            }
            return 'Не могу перевести это слово. Попробуйте другое.';
        }

        // Функция конвертации валют
        function convertCurrency(amount, from, to) {
            if (!exchangeRates[from] || !exchangeRates[to]) {
                return 'Не знаю курс для этих валют. Доступные валюты: USD, EUR, GBP, JPY, CNY.';
            }
            
            const rubAmount = amount * exchangeRates[from];
            const result = rubAmount / exchangeRates[to];
            return `${amount} ${from} = ${result.toFixed(2)} ${to}`;
        }

        // Функция работы с текстом
        function processText(text, operation) {
            switch(operation) {
                case 'length':
                    return `В тексте ${text.length} символов`;
                case 'reverse':
                    return text.split('').reverse().join('');
                case 'uppercase':
                    return text.toUpperCase();
                case 'lowercase':
                    return text.toLowerCase();
                case 'wordcount':
                    const words = text.split(/\s+/).filter(word => word.length > 0);
                    return `В тексте ${words.length} слов`;
                default:
                    return 'Неизвестная операция с текстом';
            }
        }

        // Функция извлечения поискового запроса
        function extractSearchQuery(message) {
            const searchPatterns = [
                /найди (.+)/i,
                /что такое (.+)/i,
                /кто такой (.+)/i,
                /кто такая (.+)/i,
                /что значит (.+)/i,
                /информация о (.+)/i,
                /расскажи о (.+)/i,
                /поищи (.+)/i,
                /найти (.+)/i
            ];

            for (const pattern of searchPatterns) {
                const match = message.match(pattern);
                if (match && match[1]) {
                    return match[1].trim();
                }
            }
            return null;
        }

        // Функция извлечения математического выражения
        function extractMathExpression(message) {
            const mathPatterns = [
                /реши (.+)/i,
                /посчитай (.+)/i,
                /вычисли (.+)/i,
                /сколько будет (.+)/i,
                /реши пример (.+)/i
            ];

            for (const pattern of mathPatterns) {
                const match = message.match(pattern);
                if (match && match[1]) {
                    return match[1].trim();
                }
            }
            return null;
        }

        // Функция извлечения параметров для случайного числа
        function extractRandomParams(message) {
            const rangePattern = /число от (\d+) до (\d+)/i;
            const match = message.match(rangePattern);
            if (match) {
                return {
                    min: parseInt(match[1]),
                    max: parseInt(match[2])
                };
            }
            return { min: 1, max: 100 };
        }

        // Функция извлечения параметров для конвертации валют
        function extractCurrencyParams(message) {
            const patterns = [
                /(\d+)\s*(рублей|руб)\s*(в|to)\s*(доллары|usd)/i,
                /(\d+)\s*(долларов|usd)\s*(в|to)\s*(рубли|rub)/i
            ];

            for (const pattern of patterns) {
                const match = message.match(pattern);
                if (match) {
                    const amount = parseFloat(match[1]);
                    let from, to;

                    if (match[2].toLowerCase().includes('руб')) {
                        from = 'RUB';
                    } else if (match[2].toLowerCase().includes('доллар')) {
                        from = 'USD';
                    }

                    if (match[4].toLowerCase().includes('руб')) {
                        to = 'RUB';
                    } else if (match[4].toLowerCase().includes('доллар')) {
                        to = 'USD';
                    }

                    if (from && to) {
                        return { amount, from, to };
                    }
                }
            }
            return null;
        }

        // Функция показа индикатора набора
        function showTypingIndicator() {
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message assistant';
            typingDiv.id = 'typingIndicator';
            
            const selectedModel = modelSelect.value;
            const avatarIcon = selectedModel === 'synpwide' ? 'fa-cat' : 'fa-robot';
            
            typingDiv.innerHTML = `
                <div class="avatar ${selectedModel === 'synpwide' ? 'synpwide-avatar' : ''}">
                    <i class="fas ${avatarIcon}"></i>
                    ${selectedModel === 'synpwide' ? '<div class="avatar-ring"></div>' : ''}
                </div>
                <div class="message-content">
                    <div class="typing-indicator">
                        <span>${selectedModel === 'synpwide' ? 'Думаю...' : 'Synapse.AI печатает'}</span>
                        <div class="typing-dots">
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                        </div>
                    </div>
                </div>
            `;
            messagesContainer.appendChild(typingDiv);
            scrollToBottom();
        }

        // Функция удаления индикатора набора
        function removeTypingIndicator() {
            const typingIndicator = document.getElementById('typingIndicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }

        // Функция прокрутки к низу
        function scrollToBottom() {
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Функция регулировки высоты textarea
        function adjustTextareaHeight() {
            messageInput.style.height = 'auto';
            messageInput.style.height = Math.min(messageInput.scrollHeight, 120) + 'px';
        }

        // Функция отправки сообщения
        async function sendMessage() {
            const message = messageInput.value.trim();
            if (!message) return;

            addMessage(message, 'user');
            messageInput.value = '';
            adjustTextareaHeight();
            sendButton.disabled = true;

            const selectedModel = modelSelect.value;

            showTypingIndicator();

            const delay = 1000 + Math.random() * 2000;
            
            setTimeout(async () => {
                try {
                    let response;

                    if (selectedModel === 'synpwide') {
                        const command = checkCommand(message, 'synpwide');
                        
                        if (command) {
                            let result = '';
                            let generatedResponse = '';
                            
                            switch(command.type) {
                                case 'greeting':
                                    generatedResponse = MessageGenerator.generateGreeting();
                                    break;
                                    
                                case 'howareyou':
                                    generatedResponse = MessageGenerator.generateHowAreYou();
                                    break;

                                case 'compl':
                                    generatedResponse = MessageGenerator.generateCompl();
                                    break;
                                    
                                case 'capabilities':
                                    generatedResponse = MessageGenerator.generateCapabilities();
                                    break;
                                    
                                case 'thanks':
                                    generatedResponse = MessageGenerator.generateThanks();
                                    break;
                                    
                                case 'goodbye':
                                    generatedResponse = MessageGenerator.generateGoodbye();
                                    break;
                                    
                                case 'random':
                                    const params = extractRandomParams(message);
                                    result = generateRandomNumber(params.min, params.max);
                                    generatedResponse = MessageGenerator.generateRandomResponse(result);
                                    break;
                                    
                                case 'math':
                                    const mathExpr = extractMathExpression(message);
                                    if (mathExpr) {
                                        result = solveMathExpression(mathExpr);
                                        if (result === null) {
                                            generatedResponse = MessageGenerator.generateErrorResponse();
                                        } else {
                                            generatedResponse = MessageGenerator.generateMathResponse(result);
                                        }
                                    }
                                    break;
                                    
                                case 'joke':
                                    result = getRandomJoke();
                                    generatedResponse = MessageGenerator.generateJokeResponse(result);
                                    break;
                                    
                                case 'fact':
                                    result = getRandomFact();
                                    generatedResponse = MessageGenerator.generateFactResponse(result);
                                    break;
                                    
                                case 'time':
                                    result = getCurrentDateTime();
                                    generatedResponse = MessageGenerator.generateTimeResponse(result);
                                    break;

                                case 'whatmake':
                                    generatedResponse = MessageGenerator.generateWhatMake(result);
                                    break;

                                case 'nastr':
                                    generatedResponse = MessageGenerator.generateNastr(result);
                                    break;

                                case 'badwords':
                                    generatedResponse = MessageGenerator.generateBadwords();
                                    break;
                                
                                case 'whoareyou':
                                    generatedResponse = MessageGenerator.generateWhoAreYou();
                                    break;
                                    
                                case 'sorrying':
                                    generatedResponse = MessageGenerator.generateSorrying();
                                    break; 

                                case 'helping':
                                    generatedResponse = MessageGenerator.generateHelpAns();
                                    break; 

                                case 'age':
                                    generatedResponse = MessageGenerator.generateAge();
                                    break; 
                                    
                                case 'translate':
                                    const textToTranslate = message.replace(/переведи|перевод|translate/gi, '').trim();
                                    result = translateText(textToTranslate);
                                    generatedResponse = MessageGenerator.generateTranslateResponse(result);
                                    break;
                                    
                                case 'currency':
                                    const currencyParams = extractCurrencyParams(message);
                                    if (currencyParams) {
                                        result = convertCurrency(currencyParams.amount, currencyParams.from, currencyParams.to);
                                        generatedResponse = MessageGenerator.generateCurrencyResponse(result);
                                    } else {
                                        generatedResponse = MessageGenerator.generateNotFoundResponse();
                                    }
                                    break;
                                    
                                case 'text':
                                    const textOps = {
                                        'посчитай символы': 'length',
                                        'количество символов': 'length',
                                        'длина текста': 'length',
                                        'переверни текст': 'reverse',
                                        'верхний регистр': 'uppercase',
                                        'нижний регистр': 'lowercase',
                                        'количество слов': 'wordcount'
                                    };
                                    
                                    let operation = 'length';
                                    for (const [key, value] of Object.entries(textOps)) {
                                        if (message.toLowerCase().includes(key)) {
                                            operation = value;
                                            break;
                                        }
                                    }
                                    
                                    const textToProcess = message.replace(/посчитай символы|количество символов|длина текста|переверни текст|верхний регистр|нижний регистр|количество слов/gi, '').trim();
                                    result = processText(textToProcess, operation);
                                    generatedResponse = MessageGenerator.generateTextResponse(result);
                                    break;
                                    
                                case 'search':
                                    removeTypingIndicator();
                                    addMessage(MessageGenerator.generateSearchResponse(), 'assistant', true);
                                    
                                    const searchQuery = extractSearchQuery(message);
                                    if (searchQuery) {
                                        showTypingIndicator();
                                        setTimeout(async () => {
                                            try {
                                                const searchResult = await getDuckDuckGoResponse(searchQuery, selectedModel);
                                                removeTypingIndicator();
                                                addMessage(searchResult, 'assistant');
                                            } catch (error) {
                                                removeTypingIndicator();
                                                addMessage(MessageGenerator.generateNotFoundResponse(), 'assistant');
                                            }
                                        }, 1000);
                                    }
                                    sendButton.disabled = false;
                                    return;
                                    
                                default:
                                    generatedResponse = MessageGenerator.generateErrorResponse();
                            }
                            
                            removeTypingIndicator();
                            addMessage(generatedResponse, 'assistant', true);
                            
                        } else {
                            removeTypingIndicator();
                            const searchQuery = extractSearchQuery(message);
                            
                            if (searchQuery) {
                                addMessage(MessageGenerator.generateSearchResponse(), 'assistant', true);
                                
                                showTypingIndicator();
                                setTimeout(async () => {
                                    try {
                                        const searchResult = await getDuckDuckGoResponse(searchQuery, selectedModel);
                                        removeTypingIndicator();
                                        addMessage(searchResult, 'assistant');
                                    } catch (error) {
                                        removeTypingIndicator();
                                        addMessage(MessageGenerator.generateNotFoundResponse(), 'assistant');
                                    }
                                }, 1000);
                            } else {
                                addMessage(MessageGenerator.generateErrorResponse(), 'assistant');
                            }
                        }
                    } else {
                        const command = checkCommand(message, 'synsearch');
                        
                        if (command) {
                            removeTypingIndicator();
                            if (command.type === 'greeting') {
                                addMessage(MessageGenerator.getRandom(synsearchCommands.greeting.responses), 'assistant');
                            }
                        } else {
                            removeTypingIndicator();
                            const searchResult = await getDuckDuckGoResponse(message, selectedModel);
                            addMessage(searchResult, 'assistant');
                        }
                    }
                    
                } catch (error) {
                    removeTypingIndicator();
                    addMessage(MessageGenerator.generateErrorResponse(), 'assistant');
                    console.error('Error:', error);
                }

                sendButton.disabled = false;
                scrollToBottom();
            }, delay);
        }

        // Функция получения ответа от DuckDuckGo
        async function getDuckDuckGoResponse(query, model) {
            try {
                const apiUrl = `${DUCKDUCKGO_API}?q=${encodeURIComponent(query)}&format=json&no_html=1&skip_disambig=1`;
                const response = await fetch(apiUrl);
                
                if (!response.ok) {
                    throw new Error('Ошибка сети');
                }

                const data = await response.json();
                return formatDuckDuckGoResponse(data, query, model);
                
            } catch (error) {
                return MessageGenerator.generateNotFoundResponse();
            }
        }

        // Функция форматирования ответа от DuckDuckGo
        function formatDuckDuckGoResponse(data, query, model) {
            let responseHTML = '';

            if (data.Abstract && data.Abstract !== '') {
                const sourceInfo = data.AbstractURL ? 
                    `<div class="source-info">
                        <i class="fas fa-external-link-alt"></i>
                        Источник: ${new URL(data.AbstractURL).hostname}
                    </div>` : '';

                responseHTML = `
                    <div class="message-text">
                        ${MessageGenerator.getRandom(messageParts.searchPhrases)} "${query}":
                    </div>
                    <div class="info-card">
                        <div class="info-header">
                            <i class="fas fa-info-circle info-icon"></i>
                            <div class="info-title">${data.Heading || query}</div>
                        </div>
                        <div class="info-content">${data.Abstract}</div>
                        ${data.AbstractURL ? `
                            <a href="${data.AbstractURL}" class="info-link" target="_blank" rel="noopener">
                                <i class="fas fa-external-link-alt"></i>
                                Подробнее
                            </a>
                        ` : ''}
                        ${sourceInfo}
                    </div>
                `;
            } else {
                responseHTML = `
                    <div class="message-text">
                        ${MessageGenerator.generateNotFoundResponse()}
                    </div>
                `;
            }

            return responseHTML;
        }

        // Инициализация
        initChats();

        // Обработчики событий
        newChatBtn.addEventListener('click', createNewChat);
        sendButton.addEventListener('click', sendMessage);

        messageInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        messageInput.addEventListener('input', () => {
            adjustTextareaHeight();
            sendButton.disabled = messageInput.value.trim() === '';
        });

        messageInput.focus();

        modelSelect.addEventListener('change', () => {
            const selectedModel = modelSelect.value;
            const currentChat = chats.find(c => c.id === currentChatId);
            if (currentChat) {
                currentChat.model = selectedModel;
                saveChats();
                renderChatsList();
                
                if (selectedModel === 'synpwide') {
                    addMessage(MessageGenerator.generateGreeting(), 'assistant');
                } else {
                    addMessage('SynSearch Legacy активирован. Готов к поиску информации.', 'assistant');
                }
            }
        });
    </script>
</body>
</html>
